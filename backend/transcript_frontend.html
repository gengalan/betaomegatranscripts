<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Transcript Parser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .quarter-header {
            background-color: #f8f9fa;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .deans-list {
            color: #198754;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .course-table {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1 class="mb-4">Academic Transcript Parser</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Upload Transcript</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications"></div>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="transcriptFile" class="form-label">Select PDF transcript file:</label>
                                <input class="form-control" type="file" id="transcriptFile" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload and Parse</button>
                        </form>
                        <div id="loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Parsing transcript...</p>
                        </div>
                    </div>
                </div>
                
                <div id="results" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <h5>Student Information</h5>
                            <button class="btn btn-sm btn-outline-secondary" id="backButton">Upload Another</button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Name:</strong> <span id="studentName"></span></p>
                                    <p><strong>Student ID:</strong> <span id="studentId"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Cumulative GPA:</strong> <span id="cumulativeGpa"></span></p>
                                    <p><strong>Total Credits:</strong> <span id="totalCredits"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="mt-4 mb-3">Academic Quarters</h3>
                    <div id="quartersContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const backButton = document.getElementById('backButton');
            
            // Handle form submission
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Clear any existing notifications
                document.getElementById('notifications').innerHTML = '';
                
                const fileInput = document.getElementById('transcriptFile');
                if (fileInput.files.length === 0) {
                    alert('Please select a transcript file');
                    return;
                }
                
                const file = fileInput.files[0];
                if (!file.name.endsWith('.pdf')) {
                    alert('Only PDF files are supported');
                    return;
                }
                
                // Show loading indicator
                uploadForm.style.display = 'none';
                loading.style.display = 'block';
                
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload transcript
                fetch('http://localhost:8000/upload-transcript/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to parse transcript');
                    }
                    return response.json();
                })
                .then(data => {
                    // Clear any existing notifications
                    document.getElementById('notifications').innerHTML = '';
                    
                    // Add notification if this is an update to existing record
                    if (data.isUpdate) {
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-info';
                        notification.textContent = `Updated existing record for student ${data.student_id}.`;
                        document.getElementById('notifications').appendChild(notification);
                    }
                })
                .then(data => {
                    // Hide loading and show results
                    loading.style.display = 'none';
                    results.style.display = 'block';
                    
                    // Display student information
                    document.getElementById('studentName').textContent = data.name;
                    document.getElementById('studentId').textContent = data.student_id;
                    document.getElementById('cumulativeGpa').textContent = data.cumulative_gpa.toFixed(2);
                    document.getElementById('totalCredits').textContent = data.total_credits.toFixed(1);
                    
                    // Display quarters
                    displayQuarters(data.quarters);
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                    uploadForm.style.display = 'block';
                    alert('Error parsing transcript: ' + error.message);
                });
            });
            
            // Back button
            backButton.addEventListener('click', function() {
                results.style.display = 'none';
                uploadForm.style.display = 'block';
                document.getElementById('transcriptFile').value = '';
                document.getElementById('quartersContainer').innerHTML = '';
                document.getElementById('notifications').innerHTML = '';
            });
            
            // Function to display quarters
            function displayQuarters(quarters) {
                const container = document.getElementById('quartersContainer');
                container.innerHTML = '';
                
                // Sort quarters chronologically
                quarters.sort((a, b) => {
                    if (a.quarter_year !== b.quarter_year) {
                        return a.quarter_year - b.quarter_year;
                    }
                    
                    const quarterOrder = { 'AUTUMN': 1, 'WINTER': 2, 'SPRING': 3, 'SUMMER': 4 };
                    return quarterOrder[a.quarter_name] - quarterOrder[b.quarter_name];
                });
                
                quarters.forEach(quarter => {
                    const quarterDiv = document.createElement('div');
                    quarterDiv.className = 'card mb-4';
                    
                    // Quarter header
                    const header = document.createElement('div');
                    header.className = 'card-header';
                    
                    const title = document.createElement('h5');
                    title.textContent = `${quarter.quarter_name} ${quarter.quarter_year}`;
                    
                    if (quarter.grade === 'IN_PROGRESS') {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-warning ms-2';
                        badge.textContent = 'In Progress';
                        title.appendChild(badge);
                    }
                    
                    header.appendChild(title);
                    quarterDiv.appendChild(header);
                    
                    // Quarter body
                    const body = document.createElement('div');
                    body.className = 'card-body';
                    
                    // Quarter summary
                    const summary = document.createElement('div');
                    summary.className = 'quarter-header d-flex justify-content-between';
                    
                    const leftInfo = document.createElement('div');
                    leftInfo.innerHTML = `<strong>Credits:</strong> ${quarter.quarter_credits.toFixed(1)}`;
                    
                    const rightInfo = document.createElement('div');
                    if (quarter.grade !== 'IN_PROGRESS') {
                        rightInfo.innerHTML = `<strong>GPA:</strong> ${quarter.quarter_gpa.toFixed(2)}`;
                        
                        if (quarter.deans_list) {
                            const deansList = document.createElement('span');
                            deansList.className = 'deans-list ms-3';
                            deansList.innerHTML = '🏆 Dean\'s List';
                            rightInfo.appendChild(deansList);
                        }
                    } else {
                        rightInfo.innerHTML = '<em>Quarter in progress</em>';
                    }
                    
                    summary.appendChild(leftInfo);
                    summary.appendChild(rightInfo);
                    body.appendChild(summary);
                    
                    // Course table
                    if (quarter.courses && quarter.courses.length > 0) {
                        const table = document.createElement('table');
                        table.className = 'table table-hover course-table';
                        
                        // Table header
                        const thead = document.createElement('thead');
                        thead.innerHTML = `
                            <tr>
                                <th>Course</th>
                                <th>Title</th>
                                <th>Credits</th>
                                <th>Grade</th>
                            </tr>
                        `;
                        table.appendChild(thead);
                        
                        // Table body
                        const tbody = document.createElement('tbody');
                        quarter.courses.forEach(course => {
                            const tr = document.createElement('tr');
                            
                            const courseCode = document.createElement('td');
                            courseCode.textContent = `${course.dept_code} ${course.course_number}`;
                            
                            const courseTitle = document.createElement('td');
                            courseTitle.textContent = course.course_name;
                            
                            const credits = document.createElement('td');
                            credits.textContent = course.credits.toFixed(1);
                            
                            const grade = document.createElement('td');
                            grade.textContent = course.grade === 'IN_PROGRESS' ? 'In Progress' : course.grade;
                            
                            tr.appendChild(courseCode);
                            tr.appendChild(courseTitle);
                            tr.appendChild(credits);
                            tr.appendChild(grade);
                            
                            tbody.appendChild(tr);
                        });
                        
                        table.appendChild(tbody);
                        body.appendChild(table);
                    } else {
                        const noCourses = document.createElement('p');
                        noCourses.className = 'text-muted';
                        noCourses.textContent = 'No courses found for this quarter.';
                        body.appendChild(noCourses);
                    }
                    
                    quarterDiv.appendChild(body);
                    container.appendChild(quarterDiv);
                });
            }
        });
    </script>
</body>
</html>